name: Functional tests

on: workflow_call

jobs:
  python-versions:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          pyproject.toml
          tox.ini
        sparse-checkout-cone-mode: false
    - name: Python versions
      id: versions
      uses: lime-actions/python-version-range@latest
    outputs:
      range: ${{ steps.versions.outputs.limits }}
  tests:
    needs: python-versions
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macOS-latest]
        python-version: ${{ fromJson(needs.python-versions.outputs.range) }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          dependencies/
          pyproject.toml
          readme/
          src/
          tests/
        sparse-checkout-cone-mode: false
    - name: Install uv
      uses: astral-sh/setup-uv@v3
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version-file: 'pyproject.toml'
    - name: Install and run the tests
      run: |
        uv tool install -e .[test-unittests]
        uv tool run limedev unittests
