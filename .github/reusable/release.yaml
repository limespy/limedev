name: Release
description: Build and publish package to TestPyPI

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string

jobs:
  tests:
    uses: Limespy/limedev/.github/workflows/tests.yaml@v0

  build_and_publish:
    needs: tests
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Build
        uses: Limespy/limedev/.github/actions/_build.yaml@v0
        with:
          python-version: ${{ inputs.python-version }}
          packaging-args: ${{ github.ref == 'refs/heads/main' && '--build' || '--build --build-number' }}
      - name: Publish
        uses: pypa/gh-action-pypi-publish@v1
        with:
          repository-url: ${{ github.ref == 'refs/heads/main' && 'https://upload.pypi.org/legacy/' || 'https://test.pypi.org/legacy/' }}
